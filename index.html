<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سینمازمون | رقابت فیلمی</title>
    <style>
        /* استایل‌های قبلی (همانند کد قبل) */
        @keyframes fadeIn { /* ... */ }
        /* ... سایر انیمیشن‌ها ... */
        
        .difficulty-btns {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        .difficulty-btn {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        .easy { background: #4CAF50; }
        .medium { background: #FFC107; color: #000; }
        .hard { background: #F44336; }
        .share-code {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            margin: 15px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <!-- محتوای قبلی (صفحه ثبت نام/بازی) -->
    
    <!-- بخش جدید: انتخاب سطح دشواری -->
    <div id="difficulty-screen" class="hidden">
        <h2>سطح دشواری رو انتخاب کن</h2>
        <div class="difficulty-btns">
            <button class="difficulty-btn easy" onclick="startGame('easy')">آسان</button>
            <button class="difficulty-btn medium" onclick="startGame('medium')">متوسط</button>
            <button class="difficulty-btn hard" onclick="startGame('hard')">سخت</button>
        </div>
    </div>

    <!-- بخش جدید: نتیجه رقابت -->
    <div id="competition-result" class="hidden">
        <h2 id="result-title"></h2>
        <div id="vs-container" style="font-size: 24px; margin: 20px 0;">
            <span id="user-score">0</span> 🆚 <span id="ai-score">0</span>
        </div>
        <div id="result-message"></div>
        <div class="share-code" id="share-code"></div>
        <button onclick="saveCompetitionResult()">ذخیره نتیجه</button>
    </div>

    <script>
        // ██████████████████████████████████████████████████████████████████████
        // ███ بخش جدید: سیستم رقابت پیشرفته ███
        // ██████████████████████████████████████████████████████████████████████

        // —— ۱. رقابت با کامپیوتر ——
        function generateAIScore(difficulty) {
            const baseScore = Math.floor(Math.random() * 60) + 40; // 40-100
            switch(difficulty) {
                case 'easy': return baseScore - 15;
                case 'hard': return baseScore + 25;
                default: return baseScore;
            }
        }

        // —— ۲. جدول رقابت هفتگی ——
        const weeklyLeaderboard = JSON.parse(localStorage.getItem('weeklyLB')) || [];
        
        function updateLeaderboard(userScore, aiScore) {
            weeklyLeaderboard.push({
                name: currentUser.username,
                userScore,
                aiScore,
                date: new Date().toLocaleDateString('fa-IR'),
                timestamp: Date.now()
            });
            
            // فقط ۱۰۰ رکورد آخر نگه دار
            if(weeklyLeaderboard.length > 100) weeklyLeaderboard.shift();
            
            localStorage.setItem('weeklyLB', JSON.stringify(weeklyLeaderboard));
        }

        // —— ۳. اشتراک‌گذاری نتایج ——
        function generateShareCode(userScore, aiScore) {
            return btoa(JSON.stringify({
                n: currentUser.username,
                s: userScore,
                a: aiScore,
                d: new Date().toLocaleDateString('fa-IR'),
                v: "1.0"
            }));
        }

        // —— ۴. نمایش نتیجه رقابت ——
        function showCompetitionResult(userScore, aiScore) {
            const resultTitle = document.getElementById("result-title");
            const resultMessage = document.getElementById("result-message");
            
            document.getElementById("user-score").textContent = userScore;
            document.getElementById("ai-score").textContent = aiScore;
            
            if(userScore > aiScore) {
                resultTitle.textContent = "🎉 شما برنده شدید!";
                resultMessage.innerHTML = `امتیاز شما <strong>${userScore}</strong> از ${totalQuestions}`;
            } else {
                resultTitle.textContent = "🤖 کامپیوتر برنده شد!";
                resultMessage.innerHTML = `امتیاز شما <strong>${userScore}</strong> از ${totalQuestions}`;
            }
            
            document.getElementById("share-code").textContent = 
                `کد نتیجه: ${generateShareCode(userScore, aiScore)}`;
            
            document.getElementById("game-screen").classList.add("hidden");
            document.getElementById("competition-result").classList.remove("hidden");
        }

        // —— ۵. ذخیره نتیجه ——
        function saveCompetitionResult() {
            const userScore = parseInt(document.getElementById("user-score").textContent);
            const aiScore = parseInt(document.getElementById("ai-score").textContent);
            
            updateLeaderboard(userScore, aiScore);
            alert("نتیجه در جدول رقابت ذخیره شد!");
            backToMain();
        }

        // ██████████████████████████████████████████████████████████████████████
        // ███ تغییرات در توابع موجود ███
        // ██████████████████████████████████████████████████████████████████████

        // —— تغییر در تابع startGame ——
        function startGame(difficulty) {
            // ... کدهای قبلی ...
            
            // بعد از پایان بازی:
            const aiScore = generateAIScore(difficulty);
            showCompetitionResult(finalScore, aiScore);
        }

        // —— تغییر در صفحه اصلی ——
        function showMainMenu() {
            // اضافه کردن دکمه جدول رقابت
            const html = `
                <button id="competition-btn">رقابت با کامپیوتر</button>
                <button id="leaderboard-btn">جدول رقابت هفتگی</button>
            `;
            document.getElementById("main-menu").innerHTML += html;
            
            document.getElementById("competition-btn").addEventListener("click", () => {
                document.getElementById("difficulty-screen").classList.remove("hidden");
            });
        }
    </script>
</body>
</html>
